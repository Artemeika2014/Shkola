<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nemoyashkola PRO ‚Äî Firebase</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#f5f7ff; --bg2:#eef3ff;
      --card:#ffffff; --border:rgba(25,35,60,.10);
      --text:#12182a; --muted:rgba(18,24,42,.62);
      --primary:#4f7cff; --primary2:#7c4dff; --primarySoft:rgba(79,124,255,.12);
      --ok:#19c37d; --okSoft:rgba(25,195,125,.12);
      --warn:#f59e0b; --warnSoft:rgba(245,158,11,.14);
      --danger:#ff4d4f; --dangerSoft:rgba(255,77,79,.14);
      --shadow:0 14px 40px rgba(16,24,40,.08);
      --shadow2:0 18px 54px rgba(16,24,40,.12);
      --r:18px;
    }
    body.dark{
      --bg:#0b1020; --bg2:#0a1230;
      --card:rgba(255,255,255,.07); --border:rgba(255,255,255,.14);
      --text:#eef2ff; --muted:rgba(238,242,255,.72);
      --primary:#6aa3ff; --primary2:#a78bfa; --primarySoft:rgba(106,163,255,.16);
      --ok:#35d48c; --okSoft:rgba(53,212,140,.14);
      --warn:#fbbf24; --warnSoft:rgba(251,191,36,.14);
      --danger:#ff6a6a; --dangerSoft:rgba(255,106,106,.14);
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --shadow2:0 22px 74px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(124,77,255,.18), transparent 55%),
        radial-gradient(900px 420px at 95% 10%, rgba(79,124,255,.20), transparent 50%),
        linear-gradient(180deg,var(--bg),var(--bg2));
      min-height:100vh;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 110px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .t{font-weight:950;font-size:22px;letter-spacing:.2px}
    .brand .s{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .title{font-weight:950;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.45}
    .hr{height:1px;background:var(--border);margin:14px 0}

    .input,.select,.ta{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 88%, transparent);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    body:not(.dark) .input, body:not(.dark) .select, body:not(.dark) .ta{ background:#fbfcff; }
    .input:focus,.select:focus,.ta:focus{
      border-color: color-mix(in srgb, var(--primary) 70%, var(--border));
      box-shadow:0 0 0 4px rgba(79,124,255,.14);
    }

    .btn{
      padding:11px 14px;border-radius:14px;border:1px solid var(--border);
      background: color-mix(in srgb, var(--primarySoft) 70%, var(--card));
      color:var(--text);font-weight:900;cursor:pointer;
      transition: transform .12s ease, box-shadow .14s ease, opacity .14s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow2)}
    .btn:active{transform:translateY(0)}
    .btn[disabled]{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
    .p{background:var(--primary);border-color:var(--primary);color:#fff}
    .ok{background:var(--okSoft);border-color:color-mix(in srgb, var(--ok) 35%, var(--border)); color:color-mix(in srgb, var(--ok) 80%, var(--text))}
    .w{background:var(--warnSoft);border-color:color-mix(in srgb, var(--warn) 35%, var(--border)); color:color-mix(in srgb, var(--warn) 85%, var(--text))}
    .d{background:var(--dangerSoft);border-color:color-mix(in srgb, var(--danger) 35%, var(--border)); color:color-mix(in srgb, var(--danger) 90%, var(--text))}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 86%, var(--primarySoft));
      font-size:13px;font-weight:900;
    }

    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:color-mix(in srgb, var(--card) 86%, var(--primarySoft));font-weight:900;cursor:pointer}
    .tab.on{background:linear-gradient(90deg,var(--primary),var(--primary2));color:#fff;border-color:transparent;box-shadow:0 10px 24px rgba(79,124,255,.22)}

    .bottom{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px;
      background: color-mix(in srgb, var(--card) 88%, transparent);
      border-top:1px solid var(--border);
      backdrop-filter: blur(14px);
    }
    .bottom .inner{max-width:1200px;margin:0 auto;display:flex;gap:10px}
    .nav{flex:1;padding:13px 10px;border-radius:16px;border:1px solid var(--border);background:color-mix(in srgb, var(--card) 86%, var(--primarySoft));font-weight:950;cursor:pointer}
    .nav.on{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 10px 24px rgba(79,124,255,.22)}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:16px;padding:12px;background: color-mix(in srgb, var(--card) 90%, transparent)}
    .item .h{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .item .h .l{font-weight:950}
    .item .h .r{color:var(--muted);font-size:13px;font-weight:900}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}

    .marks{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .m{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:40px;height:34px;padding:0 10px;border-radius:12px;
      border:1px solid var(--border);font-weight:950;
      background: color-mix(in srgb, var(--card) 86%, var(--primarySoft));
    }
    .m5{background:rgba(25,195,125,.14);border-color:rgba(25,195,125,.35);color:color-mix(in srgb, var(--ok) 80%, var(--text))}
    .m4{background:rgba(79,124,255,.14);border-color:rgba(79,124,255,.35);color:color-mix(in srgb, var(--primary) 85%, var(--text))}
    .m3{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35);color:color-mix(in srgb, var(--warn) 90%, var(--text))}
    .m2,.m1{background:rgba(255,77,79,.14);border-color:rgba(255,77,79,.35);color:color-mix(in srgb, var(--danger) 90%, var(--text))}
    .mN,.mO{background:rgba(160,170,190,.18);border-color:rgba(160,170,190,.35);color:color-mix(in srgb, var(--text) 90%, var(--text))}

    .bannerDanger{
      border:2px solid #ff0000;
      background: color-mix(in srgb, #ffeaea 85%, var(--card));
      border-radius:16px;padding:12px;color:#d10000;font-weight:950;text-align:center;margin-bottom:12px;
    }
    body.dark .bannerDanger{ background: rgba(255,0,0,.10); }

    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    dialog#dlg{border:none;padding:0;border-radius:18px;width:min(980px, calc(100vw - 24px));box-shadow:0 18px 60px rgba(0,0,0,.35);background:transparent}
    dialog::backdrop{background:rgba(0,0,0,.35)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="t">Nemoyashkola PRO</div>
        <div class="s">Firebase ‚Ä¢ –£—á–∏—Ç–µ–ª—å/–£—á–µ–Ω–∏–∫/–†–æ–¥–∏—Ç–µ–ª—å ‚Ä¢ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–∞–º ‚Ä¢ –û—Ü–µ–Ω–∫–∏ ‚Ä¢ –ó–∞–¥–∞–Ω–∏—è ‚Ä¢ –ü—Ä–æ–ø—É—Å–∫</div>
      </div>
      <div class="row">
        <button class="btn" id="btnTheme">üåì</button>
        <button class="btn" id="btnLogout" style="display:none">–í—ã–π—Ç–∏</button>
        <button class="btn d" id="btnReset" style="display:none" title="–£–¥–∞–ª–∏—Ç –í–°–Å –∏–∑ Firebase">–°–±—Ä–æ—Å –±–∞–∑—ã</button>
      </div>
    </div>

    <div id="app"></div>
  </div>

  <div class="bottom" id="bottom" style="display:none">
    <div class="inner">
      <button class="nav" id="navSchedule">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
      <button class="nav" id="navGrades">‚≠ê –û—Ü–µ–Ω–∫–∏</button>
      <button class="nav" id="navTasks">‚úÖ –ó–∞–¥–∞–Ω–∏—è</button>
      <button class="nav" id="navSkips">üö´ –ü—Ä–æ–ø—É—Å–∫</button>
    </div>
  </div>

  <dialog id="dlg"></dialog>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1L56PhFxIWQGNAcp16cSOFgqX_-BGjwE",
  authDomain: "nemoyashkola.firebaseapp.com",
  databaseURL: "https://nemoyashkola-default-rtdb.firebaseio.com",
  projectId: "nemoyashkola",
  storageBucket: "nemoyashkola.firebasestorage.app",
  messagingSenderId: "525343937365",
  appId: "1:525343937365:web:fbbc74257a7ef7936495dc"
};
firebase.initializeApp(firebaseConfig);
const rtdb = firebase.database();
const ROOT = "nemoyashkola";
const RESET_PASSWORD = "LOMTIKmilkiway67";

const $ = (s)=>document.querySelector(s);
const app = $("#app");
const dlg = $("#dlg");

const SETTINGS_KEY = "nemo_settings_v1";
const SESSION_KEY  = "nemo_session_v1";

const DAYS = [
  {id:1,name:"–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫"},
  {id:2,name:"–í—Ç–æ—Ä–Ω–∏–∫"},
  {id:3,name:"–°—Ä–µ–¥–∞"},
  {id:4,name:"–ß–µ—Ç–≤–µ—Ä–≥"},
  {id:5,name:"–ü—è—Ç–Ω–∏—Ü–∞"},
];
const MONTHS = ["—è–Ω–≤","—Ñ–µ–≤","–º–∞—Ä","–∞–ø—Ä","–º–∞—è","–∏—é–Ω","–∏—é–ª","–∞–≤–≥","—Å–µ–Ω","–æ–∫—Ç","–Ω–æ—è","–¥–µ–∫"];

function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function uid(p="id"){ return p+"_"+Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
function norm(s){ return (s||"").trim().replace(/\s+/g," "); }
function pad2(n){ return String(n).padStart(2,"0"); }
function toISO(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function fromISO(iso){ const [y,m,d]=iso.split("-").map(Number); return new Date(y,m-1,d); }
function todayISO(){ return toISO(new Date()); }

function weekdayId(iso){
  const wd = fromISO(iso).getDay();
  if(wd===0 || wd===6) return null;
  return wd;
}
function mondayOfWeek(date){
  const d = new Date(date);
  const day = d.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d;
}
function weekDates(offset){
  const base = new Date();
  base.setDate(base.getDate()+offset*7);
  const mon = mondayOfWeek(base);
  const out=[];
  for(let i=0;i<5;i++){ const x=new Date(mon); x.setDate(x.getDate()+i); out.push(toISO(x)); }
  return out;
}
function weekLabel(monISO){
  const mon = fromISO(monISO);
  const fri = new Date(mon); fri.setDate(fri.getDate()+4);
  return `${mon.getDate()} ${MONTHS[mon.getMonth()]} ‚Äì ${fri.getDate()} ${MONTHS[fri.getMonth()]}`;
}
function dayName(iso){
  const map={1:"–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",2:"–≤—Ç–æ—Ä–Ω–∏–∫",3:"—Å—Ä–µ–¥–∞",4:"—á–µ—Ç–≤–µ—Ä–≥",5:"–ø—è—Ç–Ω–∏—Ü–∞",6:"—Å—É–±–±–æ—Ç–∞",0:"–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"};
  return map[fromISO(iso).getDay()];
}
function genStudentLogin(fullName){
  const base=(fullName||"").toLowerCase().replace(/—ë/g,"–µ").replace(/[^a-z–∞-—è0-9]+/gi,"").slice(0,10) || "student";
  return base + Math.floor(1000+Math.random()*9000);
}
function genPass(){ return Math.random().toString(36).slice(2,10); }

function markCss(m){
  if(m==="5") return "m5";
  if(m==="4") return "m4";
  if(m==="3") return "m3";
  if(m==="2") return "m2";
  if(m==="1") return "m1";
  if(m==="N") return "mN";
  if(m==="O") return "mO";
  return "";
}

function loadSettings(){ try{return JSON.parse(localStorage.getItem(SETTINGS_KEY)||"{}");}catch{return{};} }
function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
let settings = loadSettings();
function applyTheme(){ document.body.classList.toggle("dark", settings.theme==="dark"); }
applyTheme();
$("#btnTheme").onclick=()=>{
  settings.theme = (settings.theme==="dark") ? "light" : "dark";
  saveSettings(settings); applyTheme();
};

function loadSession(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY)||"null");}catch{return null;} }
function saveSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }
let session = loadSession();
function setSession(s){
  session=s;
  if(s) saveSession(s); else clearSession();
  render();
}

function defaultDB(){
  return {
    teachers: [],       // {id, login, pass, fullName, className, cabinet, createdAt}
    students: [],       // {id, teacherId, className, fullName, login, pass, createdAt}
    parents: [],        // {id, studentId, login, pass, createdAt}
    subjects: [],       // {id, teacherId, title, teacherName, cabinet, createdAt}

    schedule_base: [],  // {id, teacherId, dayId(1-5), order(1..), subjectId}
    schedule_overrides:[],// {id, teacherId, date(ISO), lessons:[{order, subjectId, teacherName?, cabinet?}]}

    homeworks: [],      // {id, teacherId, subjectId, date(ISO), text, createdAt}
    marks: [],          // {id, teacherId, studentId, subjectId, date(ISO), lessonOrder, mark, comment, createdAt}

    taskDone: [],       // {studentId, hwId, done, updatedAt}
    parentCalls: []     // {id, teacherId, studentId, active, createdAt, closedAt?}
  };
}

let db=null;
let dbReady=false;
let saving=false;

async function ensureRoot(){
  const snap = await rtdb.ref(ROOT).once("value");
  if(!snap.exists()) await rtdb.ref(ROOT).set(defaultDB());
}
function normalizeDB(data){
  const base=defaultDB();
  const merged={...base, ...(data||{})};
  for(const k of Object.keys(base)) if(!Array.isArray(merged[k])) merged[k]=base[k];
  return merged;
}
function startSync(){
  ensureRoot().then(()=>{
    rtdb.ref(ROOT).on("value",(snap)=>{
      db = normalizeDB(snap.val());
      dbReady=true;
      render();
    },(err)=>{
      alert("Firebase read error: "+(err?.message||err));
    });
  });
}
async function saveDB(){
  if(!dbReady || !db) return;
  if(saving) return;
  saving=true;
  try{ await rtdb.ref(ROOT).set(db); } finally { saving=false; }
}

function meTeacher(){ return (session?.role==="teacher") ? db.teachers.find(t=>t.id===session.id)||null : null; }
function meStudent(){ return (session?.role==="student") ? db.students.find(s=>s.id===session.id)||null : null; }
function meParent(){ return (session?.role==="parent") ? db.parents.find(p=>p.id===session.id)||null : null; }

function teacherOfStudent(student){ return db.teachers.find(t=>t.id===student.teacherId)||null; }
function subjectsByTeacher(tid){ return db.subjects.filter(s=>s.teacherId===tid).sort((a,b)=>a.title.localeCompare(b.title,'ru')); }
function subjectById(tid, sid){ return db.subjects.find(s=>s.teacherId===tid && s.id===sid) || null; }

function baseLessonsForDay(tid, dayId){
  return db.schedule_base
    .filter(x=>x.teacherId===tid && x.dayId===dayId)
    .sort((a,b)=>a.order-b.order)
    .map(x=>({order:x.order, subjectId:x.subjectId}));
}
function overrideForDate(tid, iso){ return db.schedule_overrides.find(o=>o.teacherId===tid && o.date===iso) || null; }
function lessonsForDate(tid, iso){
  const ov = overrideForDate(tid, iso);
  if(ov) return (ov.lessons||[]).slice().sort((a,b)=>a.order-b.order);
  const dayId = weekdayId(iso);
  if(!dayId) return [];
  return baseLessonsForDay(tid, dayId);
}

function isParentsCalled(studentId){
  const last = db.parentCalls
    .filter(c=>c.studentId===studentId)
    .sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""))[0];
  return !!last?.active;
}
async function callParents(tid, studentId){
  const now = new Date().toISOString();
  db.parentCalls = db.parentCalls.map(c=> (c.studentId===studentId && c.active) ? {...c, active:false, closedAt: now} : c);
  db.parentCalls.push({id:uid("pc"), teacherId:tid, studentId, active:true, createdAt:now});
  await saveDB();
}
async function cancelCallParents(studentId){
  const now = new Date().toISOString();
  db.parentCalls = db.parentCalls.map(c=> (c.studentId===studentId && c.active) ? {...c, active:false, closedAt: now} : c);
  await saveDB();
}

function hwForTeacherWeek(tid, dates){ return db.homeworks.filter(h=>h.teacherId===tid && dates.includes(h.date)); }
function marksForStudentWeek(tid, studentId, dates){ return db.marks.filter(m=>m.teacherId===tid && m.studentId===studentId && dates.includes(m.date)); }

function getTaskDone(studentId, hwId){ return !!db.taskDone.find(x=>x.studentId===studentId && x.hwId===hwId)?.done; }
async function setTaskDone(studentId, hwId, done){
  const now=new Date().toISOString();
  const rec=db.taskDone.find(x=>x.studentId===studentId && x.hwId===hwId);
  if(rec){ rec.done=!!done; rec.updatedAt=now; }
  else db.taskDone.push({studentId, hwId, done:!!done, updatedAt:now});
  await saveDB();
}

const VIEW = { LOGIN:"login", TEACHER:"teacher", STUDENT:"student", PARENT:"parent", TEACHER_SETUP:"t_setup", TEACHER_SUBJECT:"t_subj", TEACHER_SCHEDULE:"t_sched" };
let view = VIEW.LOGIN;

let teacherTab = "journal";
let selectedSubjectId = null;

let studentTab = "grades";
let weekOffset = 0;

function showBottomNav(on){ $("#bottom").style.display = on ? "block" : "none"; }
function setNavActive(){
  $("#navSchedule").classList.toggle("on", studentTab==="schedule");
  $("#navGrades").classList.toggle("on", studentTab==="grades");
  $("#navTasks").classList.toggle("on", studentTab==="tasks");
  $("#navSkips").classList.toggle("on", studentTab==="skips");
}
$("#navSchedule").onclick=()=>{ studentTab="schedule"; render(); };
$("#navGrades").onclick=()=>{ studentTab="grades"; render(); };
$("#navTasks").onclick=()=>{ studentTab="tasks"; render(); };
$("#navSkips").onclick=()=>{ studentTab="skips"; render(); };

$("#btnLogout").onclick=()=> setSession(null);
$("#btnReset").onclick=async ()=>{
  const p = prompt("–ü–∞—Ä–æ–ª—å –¥–ª—è —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã:");
  if(p !== RESET_PASSWORD){ alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"); return; }
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –í–°–Å –∏–∑ Firebase (nemoyashkola)?")) return;
  db = defaultDB();
  await rtdb.ref(ROOT).set(db);
  setSession(null);
};

function ensureView(){
  if(!session){ view=VIEW.LOGIN; return; }
  if(session.role==="teacher"){
    const t=meTeacher();
    if(!t){ setSession(null); return; }
    if(!t.fullName || !t.className || !t.cabinet) view=VIEW.TEACHER_SETUP;
    else if(view===VIEW.LOGIN || view===VIEW.STUDENT || view===VIEW.PARENT) view=VIEW.TEACHER;
  }
  if(session.role==="student"){ view=VIEW.STUDENT; }
  if(session.role==="parent"){ view=VIEW.PARENT; }
}

function modal(html){
  dlg.innerHTML = `<div class="card" style="margin:0">${html}</div>`;
  dlg.onclick = (e)=>{ if(e.target===dlg) dlg.close(); };
  dlg.showModal();
  return dlg;
}

function render(){
  $("#btnLogout").style.display = session ? "inline-flex" : "none";
  $("#btnReset").style.display = session ? "inline-flex" : "none";

  if(!dbReady){
    app.innerHTML = `
      <div class="card">
        <div class="title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase‚Ä¶</div>
        <div class="muted" style="margin-top:6">–ï—Å–ª–∏ –≤–∏—Å–∏—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å Rules (–¥–ª—è —Ç–µ—Å—Ç–∞ read/write=true).</div>
        <div class="hr"></div>
        <div class="pill">–ü—É—Ç—å: <span class="kbd">${esc(ROOT)}</span></div>
      </div>`;
    showBottomNav(false);
    return;
  }

  ensureView();

  if(view===VIEW.LOGIN){ showBottomNav(false); return renderLogin(); }
  if(view===VIEW.TEACHER_SETUP){ showBottomNav(false); return renderTeacherSetup(); }
  if(view===VIEW.TEACHER){ showBottomNav(false); return renderTeacher(); }
  if(view===VIEW.TEACHER_SUBJECT){ showBottomNav(false); return renderTeacherSubject(); }
  if(view===VIEW.TEACHER_SCHEDULE){ showBottomNav(false); return renderTeacherSchedule(); }
  if(view===VIEW.STUDENT){ showBottomNav(true); setNavActive(); return renderStudentLike("student"); }
  if(view===VIEW.PARENT){ showBottomNav(true); setNavActive(); return renderStudentLike("parent"); }
}

function renderLogin(){
  app.innerHTML = `
    <div class="grid2">
      <div class="card">
        <div class="title">–í—Ö–æ–¥</div>
        <div class="muted" style="margin-top:6">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏ –≤–æ–π–¥–∏—Ç–µ.</div>
        <div class="hr"></div>
        <div class="tabs">
          <div class="tab on" id="tabLogin">–í—Ö–æ–¥</div>
          <div class="tab" id="tabReg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∏—Ç–µ–ª—è</div>
        </div>
        <div class="hr"></div>
        <div id="box"></div>
      </div>
      <div class="card">
        <div class="title">–í–∞–∂–Ω–æ</div>
        <div class="muted" style="margin-top:8">
          –î–µ–º–æ-–≤–µ—Ä—Å–∏—è: –ª–æ–≥–∏–Ω—ã/–ø–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ –∫–∞–∫ —Ç–µ–∫—Å—Ç. –î–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–π –∑–∞—â–∏—Ç—ã –Ω—É–∂–µ–Ω Firebase Auth + —Å—Ç—Ä–æ–≥–∏–µ Rules.
        </div>
        <div class="hr"></div>
        <div class="pill">Firebase: <span class="kbd">${esc(firebaseConfig.projectId)}</span></div>
      </div>
    </div>
  `;

  let mode="login";
  $("#tabLogin").onclick=()=>{ mode="login"; paint(); };
  $("#tabReg").onclick=()=>{ mode="reg"; paint(); };

  function paint(){
    $("#tabLogin").classList.toggle("on", mode==="login");
    $("#tabReg").classList.toggle("on", mode==="reg");

    const box=$("#box");
    if(mode==="login"){
      box.innerHTML=`
        <div class="tabs">
          <div class="tab on" id="rT">–£—á–∏—Ç–µ–ª—å</div>
          <div class="tab" id="rS">–£—á–µ–Ω–∏–∫</div>
          <div class="tab" id="rP">–†–æ–¥–∏—Ç–µ–ª—å</div>
        </div>
        <div style="margin-top:12px"><input class="input" id="login" placeholder="–õ–æ–≥–∏–Ω"></div>
        <div style="margin-top:10px"><input class="input" id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
        <div class="row" style="margin-top:12px"><button class="btn p" id="go">–í–æ–π—Ç–∏</button></div>
        <div class="muted" id="err" style="margin-top:10px; display:none; color:var(--danger)"></div>
      `;

      let role="teacher";
      const setRole=()=>{
        $("#rT").classList.toggle("on", role==="teacher");
        $("#rS").classList.toggle("on", role==="student");
        $("#rP").classList.toggle("on", role==="parent");
      };
      $("#rT").onclick=()=>{ role="teacher"; setRole(); };
      $("#rS").onclick=()=>{ role="student"; setRole(); };
      $("#rP").onclick=()=>{ role="parent"; setRole(); };

      $("#go").onclick=()=>{
        const login=norm($("#login").value);
        const pass=norm($("#pass").value);
        const err=$("#err"); err.style.display="none";
        if(!login || !pass){ err.textContent="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å."; err.style.display="block"; return; }

        if(role==="teacher"){
          const t=db.teachers.find(x=>x.login===login && x.pass===pass);
          if(!t){ err.textContent="–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å —É—á–∏—Ç–µ–ª—è."; err.style.display="block"; return; }
          teacherTab="journal"; selectedSubjectId=null;
          setSession({role:"teacher", id:t.id});
        }else if(role==="student"){
          const s=db.students.find(x=>x.login===login && x.pass===pass);
          if(!s){ err.textContent="–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å —É—á–µ–Ω–∏–∫–∞."; err.style.display="block"; return; }
          studentTab="grades"; weekOffset=0;
          setSession({role:"student", id:s.id});
        }else{
          const p=db.parents.find(x=>x.login===login && x.pass===pass);
          if(!p){ err.textContent="–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å —Ä–æ–¥–∏—Ç–µ–ª—è."; err.style.display="block"; return; }
          studentTab="grades"; weekOffset=0;
          setSession({role:"parent", id:p.id});
        }
      };
    } else {
      box.innerHTML=`
        <div class="muted">–°–æ–∑–¥–∞—ë–º –∞–∫–∫–∞—É–Ω—Ç —É—á–∏—Ç–µ–ª—è (–ª–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π).</div>
        <div style="margin-top:12px"><input class="input" id="rlogin" placeholder="–õ–æ–≥–∏–Ω —É—á–∏—Ç–µ–ª—è"></div>
        <div style="margin-top:10px"><input class="input" id="rpass" type="password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
        <div class="row" style="margin-top:12px"><button class="btn p" id="reg">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
        <div class="muted" id="err" style="margin-top:10px; display:none; color:var(--danger)"></div>
      `;
      $("#reg").onclick=async ()=>{
        const login=norm($("#rlogin").value);
        const pass=norm($("#rpass").value);
        const err=$("#err"); err.style.display="none";
        if(login.length<3 || pass.length<4){ err.textContent="–õ–æ–≥–∏–Ω ‚â• 3 —Å–∏–º–≤–æ–ª–∞, –ø–∞—Ä–æ–ª—å ‚â• 4."; err.style.display="block"; return; }
        if(db.teachers.some(t=>t.login===login)){ err.textContent="–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç."; err.style.display="block"; return; }
        const t={id:uid("t"), login, pass, fullName:"", className:"", cabinet:"", createdAt:new Date().toISOString()};
        db.teachers.push(t);
        await saveDB();
        setSession({role:"teacher", id:t.id});
      };
    }
  }
  paint();
}

function renderTeacherSetup(){
  const t=meTeacher();
  app.innerHTML=`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">–ü—Ä–æ—Ñ–∏–ª—å —É—á–∏—Ç–µ–ª—è</div>
          <div class="muted">–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å.</div>
        </div>
        <div class="pill">–õ–æ–≥–∏–Ω: <span class="kbd">${esc(t.login)}</span></div>
      </div>
      <div class="hr"></div>
      <div class="grid2">
        <div>
          <div class="muted">–ö–ª–∞—Å—Å</div>
          <input class="input" id="className" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7–ê" value="${esc(t.className||"")}">
        </div>
        <div>
          <div class="muted">–ö–∞–±–∏–Ω–µ—Ç</div>
          <input class="input" id="cabinet" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12" value="${esc(t.cabinet||"")}">
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="muted">–§–ò–û</div>
        <input class="input" id="fullName" placeholder="–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–Ω–∞" value="${esc(t.fullName||"")}">
      </div>
      <div class="row" style="margin-top:12px"><button class="btn p" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      <div class="muted" id="err" style="margin-top:10px; display:none; color:var(--danger)"></div>
    </div>
  `;
  $("#save").onclick=async ()=>{
    const className=norm($("#className").value);
    const cabinet=norm($("#cabinet").value);
    const fullName=norm($("#fullName").value);
    const err=$("#err"); err.style.display="none";
    if(!className || !cabinet || !fullName){ err.textContent="–ó–∞–ø–æ–ª–Ω–∏ –∫–ª–∞—Å—Å, –∫–∞–±–∏–Ω–µ—Ç –∏ –§–ò–û."; err.style.display="block"; return; }
    t.className=className; t.cabinet=cabinet; t.fullName=fullName;
    await saveDB();
    view=VIEW.TEACHER;
    render();
  };
}

function openAddSubject(teacherId){
  const t=meTeacher();
  const d=modal(`
    <div class="row" style="justify-content:space-between">
      <div class="title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
      <button class="btn" id="x">‚úï</button>
    </div>
    <div class="hr"></div>
    <div class="muted">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—à–µ—Ç—Å—è —É—á–∏—Ç–µ–ª—å –∏ –∫–∞–±–∏–Ω–µ—Ç.</div>
    <div style="margin-top:12px"><input class="input" id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞)"></div>
    <div class="row" style="margin-top:12px"><button class="btn p" id="add">–î–æ–±–∞–≤–∏—Ç—å</button></div>
  `);
  d.querySelector("#x").onclick=()=>d.close();
  d.querySelector("#add").onclick=async ()=>{
    const title=norm(d.querySelector("#title").value);
    if(!title){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"); return; }
    db.subjects.push({id:uid("sub"), teacherId, title, teacherName:t.fullName, cabinet:t.cabinet, createdAt:new Date().toISOString()});
    await saveDB();
    d.close();
    render();
  };
}

function openAddStudent(teacherId){
  const t=meTeacher();
  const d=modal(`
    <div class="row" style="justify-content:space-between">
      <div class="title">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</div>
      <button class="btn" id="x">‚úï</button>
    </div>
    <div class="hr"></div>
    <div class="muted">–ö–ª–∞—Å—Å –≤—ã—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: <b>${esc(t.className)}</b></div>
    <div style="margin-top:12px"><input class="input" id="fio" placeholder="–§–ò–û —É—á–µ–Ω–∏–∫–∞"></div>
    <div class="row" style="margin-top:12px"><button class="btn p" id="add">–°–æ–∑–¥–∞—Ç—å</button></div>
    <div class="hr"></div>
    <div id="creds" style="display:none"></div>
  `);
  d.querySelector("#x").onclick=()=>d.close();
  d.querySelector("#add").onclick=async ()=>{
    const fio=norm(d.querySelector("#fio").value);
    if(!fio){ alert("–í–≤–µ–¥–∏—Ç–µ –§–ò–û"); return; }
    const login=genStudentLogin(fio);
    const pass=genPass();
    const sid=uid("s");

    db.students.push({id:sid, teacherId, className:t.className, fullName:fio, login, pass, createdAt:new Date().toISOString()});

    const plogin = "parent"+Math.floor(1000+Math.random()*9000);
    const ppass  = genPass();
    db.parents.push({id:uid("p"), studentId:sid, login:plogin, pass:ppass, createdAt:new Date().toISOString()});

    await saveDB();

    const c=d.querySelector("#creds");
    c.style.display="block";
    c.innerHTML=`
      <div class="title" style="font-size:16px">–î–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã</div>
      <div class="muted" style="margin-top:6">–£—á–µ–Ω–∏–∫:</div>
      <div class="pill">–ª–æ–≥–∏–Ω: <span class="kbd">${esc(login)}</span> ‚Ä¢ –ø–∞—Ä–æ–ª—å: <span class="kbd">${esc(pass)}</span></div>
      <div class="muted" style="margin-top:10px">–†–æ–¥–∏—Ç–µ–ª—å:</div>
      <div class="pill">–ª–æ–≥–∏–Ω: <span class="kbd">${esc(plogin)}</span> ‚Ä¢ –ø–∞—Ä–æ–ª—å: <span class="kbd">${esc(ppass)}</span></div>
    `;
    d.querySelector("#add").disabled=true;
  };
}

function openStudentCard(teacherId, studentId){
  const s=db.students.find(x=>x.id===studentId && x.teacherId===teacherId);
  if(!s){ alert("–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }
  const called=isParentsCalled(studentId);

  const d=modal(`
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="title">${esc(s.fullName)}</div>
        <div class="muted">–ö–ª–∞—Å—Å: <b>${esc(s.className)}</b></div>
      </div>
      <button class="btn" id="x">‚úï</button>
    </div>
    <div class="hr"></div>
    <div class="item"><div class="h"><div class="l">–õ–æ–≥–∏–Ω</div><div class="r"><span class="kbd">${esc(s.login)}</span></div></div></div>
    <div style="height:10px"></div>
    <div class="item"><div class="h"><div class="l">–ü–∞—Ä–æ–ª—å</div><div class="r"><span class="kbd">${esc(s.pass)}</span></div></div></div>
    <div class="hr"></div>
    <div class="row"><button class="btn d" id="call">${called?"–†–æ–¥–∏—Ç–µ–ª–µ–π —É–∂–µ –≤—ã–∑–≤–∞–ª–∏ (–æ—Ç–º–µ–Ω–∏—Ç—å)":"–í—ã–∑–≤–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª–µ–π –≤ —à–∫–æ–ª—É"}</button></div>
    <div class="muted" style="margin-top:10px">–ü—Ä–∏ –≤—ã–∑–æ–≤–µ —É —É—á–µ–Ω–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫—Ä–∞—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≤–∫–ª–∞–¥–∫–µ ¬´–ü—Ä–æ–ø—É—Å–∫¬ª.</div>
  `);
  d.querySelector("#x").onclick=()=>d.close();
  d.querySelector("#call").onclick=async ()=>{
    if(isParentsCalled(studentId)) await cancelCallParents(studentId);
    else await callParents(teacherId, studentId);
    d.close();
    render();
  };
}

function renderTeacher(){
  const t=meTeacher();
  const myStudents = db.students.filter(s=>s.teacherId===t.id).sort((a,b)=>a.fullName.localeCompare(b.fullName,'ru'));
  const mySubjects = subjectsByTeacher(t.id);

  app.innerHTML=`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">${esc(t.fullName)}</div>
          <div class="muted">–ö–ª–∞—Å—Å: <b>${esc(t.className)}</b> ‚Ä¢ –ö–∞–±–∏–Ω–µ—Ç: <b>${esc(t.cabinet)}</b></div>
        </div>
        <div class="tabs">
          <div class="tab ${teacherTab==="journal"?"on":""}" id="tJournal">–ñ—É—Ä–Ω–∞–ª</div>
          <div class="tab ${teacherTab==="schedule"?"on":""}" id="tSchedule">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
          <div class="tab ${teacherTab==="students"?"on":""}" id="tStudents">–£—á–µ–Ω–∏–∫–∏</div>
        </div>
      </div>
    </div>
    <div style="height:12px"></div>
    <div id="teacherBody"></div>
  `;
  $("#tJournal").onclick=()=>{ teacherTab="journal"; renderTeacher(); };
  $("#tSchedule").onclick=()=>{ teacherTab="schedule"; renderTeacher(); };
  $("#tStudents").onclick=()=>{ teacherTab="students"; renderTeacher(); };

  const body=$("#teacherBody");

  if(teacherTab==="journal"){
    body.innerHTML=`
      <div class="grid2">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div><div class="title">–ü—Ä–µ–¥–º–µ—Ç—ã</div><div class="muted">–ù–∞–∂–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç ‚Üí –î–ó + –æ—Ü–µ–Ω–∫–∏.</div></div>
            <button class="btn p" id="addSubj">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
          </div>
          <div class="hr"></div>
          ${mySubjects.length? `<div class="list" id="subsList"></div>` : `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤.</div>`}
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div><div class="title">–£—á–µ–Ω–∏–∫–∏</div><div class="muted">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ / –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏–Ω.</div></div>
            <button class="btn p" id="addStudent">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
          </div>
          <div class="hr"></div>
          ${myStudents.length? `<div class="list" id="studList"></div>` : `<div class="muted">–£—á–µ–Ω–∏–∫–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>`}
        </div>
      </div>
    `;
    $("#addSubj").onclick=()=>openAddSubject(t.id);
    $("#addStudent").onclick=()=>openAddStudent(t.id);

    if(mySubjects.length){
      const list=$("#subsList");
      list.innerHTML = mySubjects.map(s=>`
        <div class="item" data-id="${esc(s.id)}" style="cursor:pointer">
          <div class="h">
            <div class="l">üìò ${esc(s.title)}</div>
            <div class="r">–∫–∞–±. ${esc(s.cabinet||t.cabinet)}</div>
          </div>
          <div class="sub">–£—á–∏—Ç–µ–ª—å: ${esc(s.teacherName||t.fullName)}</div>
        </div>
      `).join("");
      list.querySelectorAll(".item").forEach(el=>{
        el.onclick=()=>{
          selectedSubjectId = el.getAttribute("data-id");
          view = VIEW.TEACHER_SUBJECT;
          render();
        };
      });
    }

    if(myStudents.length){
      const list=$("#studList");
      list.innerHTML = myStudents.map(s=>`
        <div class="item">
          <div class="h">
            <div class="l">${esc(s.fullName)}</div>
            <div class="r">–ª–æ–≥–∏–Ω: <span class="kbd">${esc(s.login)}</span></div>
          </div>
          <div class="sub"><button class="btn" data-open="${esc(s.id)}">–û—Ç–∫—Ä—ã—Ç—å</button></div>
        </div>
      `).join("");
      list.querySelectorAll("button[data-open]").forEach(btn=>{
        btn.onclick=()=>openStudentCard(t.id, btn.getAttribute("data-open"));
      });
    }
  }

  if(teacherTab==="schedule"){
    body.innerHTML=`
      <div class="grid2">
        <div class="card">
          <div class="title">–ë–∞–∑–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–ü–Ω‚Äì–ü—Ç)</div>
          <div class="muted" style="margin-top:6">–®–∞–±–ª–æ–Ω. –ï—Å–ª–∏ –∑–∞–º–µ–Ω—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É ‚Äî ¬´–ü–æ –¥–∞—Ç–µ¬ª.</div>
          <div class="hr"></div>
          <button class="btn p" id="editBase">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑–æ–≤–æ–µ</button>
        </div>

        <div class="card">
          <div class="title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ</div>
          <div class="muted" style="margin-top:6">–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç, –∫–∞–±–∏–Ω–µ—Ç –∏ —É—á–∏—Ç–µ–ª—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É—Ä–æ–∫–∞—Ö.</div>
          <div class="hr"></div>
          <div class="row">
            <input class="input" id="datePick" type="date" value="${todayISO()}">
            <button class="btn p" id="editDate">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    `;
    $("#editBase").onclick=()=>{ view=VIEW.TEACHER_SCHEDULE; render(); };
    $("#editDate").onclick=()=>{
      const iso=$("#datePick").value || todayISO();
      openEditScheduleForDate(t.id, iso);
    };
  }

  if(teacherTab==="students"){
    body.innerHTML=`
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div><div class="title">–£—á–µ–Ω–∏–∫–∏</div><div class="muted">–û—Ç–∫—Ä–æ–π —É—á–µ–Ω–∏–∫–∞ ‚Üí –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å/–≤—ã–∑–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª–µ–π.</div></div>
          <button class="btn p" id="addStudent2">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
        </div>
        <div class="hr"></div>
        ${myStudents.length? `<div class="list" id="studList2"></div>` : `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤.</div>`}
      </div>
    `;
    $("#addStudent2").onclick=()=>openAddStudent(t.id);
    if(myStudents.length){
      const list=$("#studList2");
      list.innerHTML = myStudents.map(s=>`
        <div class="item">
          <div class="h">
            <div class="l">${esc(s.fullName)}</div>
            <div class="r">–ª–æ–≥–∏–Ω: <span class="kbd">${esc(s.login)}</span></div>
          </div>
          <div class="sub"><button class="btn" data-open="${esc(s.id)}">–û—Ç–∫—Ä—ã—Ç—å</button></div>
        </div>
      `).join("");
      list.querySelectorAll("button[data-open]").forEach(btn=>{
        btn.onclick=()=>openStudentCard(t.id, btn.getAttribute("data-open"));
      });
    }
  }
}

function renderTeacherSchedule(){
  const t=meTeacher();
  const subs = subjectsByTeacher(t.id);
  const maxRows = 10;

  app.innerHTML=`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">–ë–∞–∑–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
          <div class="muted">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π –ü–Ω‚Äì–ü—Ç. –ö–æ–ª-–≤–æ —É—Ä–æ–∫–æ–≤ ‚Äî —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–∏—à—å.</div>
        </div>
        <div class="row">
          <button class="btn" id="back">‚Üê –ù–∞–∑–∞–¥</button>
          <button class="btn p" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="muted">–ï—Å–ª–∏ –Ω–∞ –¥–µ–Ω—å –Ω–µ—Ç —É—Ä–æ–∫–æ–≤ ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç–æ.</div>
      <div class="hr"></div>
      <div id="days"></div>
    </div>
  `;

  $("#back").onclick=()=>{ view=VIEW.TEACHER; teacherTab="schedule"; render(); };

  const daysBox=$("#days");
  daysBox.innerHTML = DAYS.map(d=>{
    const rows = [];
    for(let i=1;i<=maxRows;i++){
      const existing = db.schedule_base.find(x=>x.teacherId===t.id && x.dayId===d.id && x.order===i);
      const val = existing?.subjectId || "";
      rows.push(`
        <div class="row" style="margin-top:8px">
          <div class="pill" style="min-width:78px;justify-content:center">–£—Ä–æ–∫ ${i}</div>
          <select class="select" data-day="${d.id}" data-order="${i}">
            <option value="">‚Äî –Ω–µ—Ç ‚Äî</option>
            ${subs.map(s=>`<option value="${esc(s.id)}" ${s.id===val?"selected":""}>${esc(s.title)}</option>`).join("")}
          </select>
        </div>
      `);
    }
    return `
      <div class="item" style="margin-bottom:12px">
        <div class="title" style="font-size:16px">${esc(d.name)}</div>
        ${rows.join("")}
      </div>
    `;
  }).join("");

  $("#save").onclick=async ()=>{
    db.schedule_base = db.schedule_base.filter(x=>x.teacherId!==t.id);
    daysBox.querySelectorAll("select[data-day]").forEach(sel=>{
      const dayId = Number(sel.getAttribute("data-day"));
      const order = Number(sel.getAttribute("data-order"));
      const sid = sel.value || "";
      if(!sid) return;
      db.schedule_base.push({id:uid("sb"), teacherId:t.id, dayId, order, subjectId:sid});
    });
    await saveDB();
    view=VIEW.TEACHER; teacherTab="schedule";
    render();
  };
}

function openEditScheduleForDate(teacherId, iso){
  const t=meTeacher();
  const subs = subjectsByTeacher(teacherId);
  const dayId = weekdayId(iso);
  if(!dayId){ alert("–≠—Ç–æ –≤—ã—Ö–æ–¥–Ω–æ–π (—Å—É–±–±–æ—Ç–∞/–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)."); return; }

  const existing = overrideForDate(teacherId, iso);
  const base = lessonsForDate(teacherId, iso);
  const maxRows = 10;

  const d=modal(`
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –¥–∞—Ç—É</div>
        <div class="muted">${esc(iso)} ‚Ä¢ ${esc(dayName(iso))}</div>
      </div>
      <button class="btn" id="x">‚úï</button>
    </div>
    <div class="hr"></div>

    <div class="muted">–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫–∞–±–∏–Ω–µ—Ç –∏ —É—á–∏—Ç–µ–ª—è –¥–ª—è –ª—é–±—ã—Ö —É—Ä–æ–∫–æ–≤ (–¥–∞–∂–µ –µ—Å–ª–∏ —É—á–∏—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω).</div>

    <div class="hr"></div>
    <div id="rows"></div>

    <div class="hr"></div>
    <div class="row">
      <button class="btn p" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn d" id="del" ${existing?"":"disabled"}>–£–¥–∞–ª–∏—Ç—å override</button>
    </div>
  `);
  d.querySelector("#x").onclick=()=>d.close();

  const rowsBox=d.querySelector("#rows");
  rowsBox.innerHTML = Array.from({length:maxRows},(_,idx)=>{
    const order=idx+1;
    const cur = base.find(x=>x.order===order) || {};
    const curSid = cur.subjectId || "";
    const curTeacher = cur.teacherName || "";
    const curCab = cur.cabinet || "";
    return `
      <div class="item" style="margin-top:10px">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div class="pill" style="min-width:88px;justify-content:center">–£—Ä–æ–∫ ${order}</div>
          <div style="flex:1">
            <div class="muted">–ü—Ä–µ–¥–º–µ—Ç</div>
            <select class="select" data-order="${order}" data-kind="subj">
              <option value="">‚Äî –Ω–µ—Ç ‚Äî</option>
              ${subs.map(s=>`<option value="${esc(s.id)}" ${s.id===curSid?"selected":""}>${esc(s.title)}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <div class="muted">–£—á–∏—Ç–µ–ª—å (override)</div>
            <input class="input" data-order="${order}" data-kind="teacher" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ç—Ä–æ–≤–∞ –ê.–ê." value="${esc(curTeacher)}">
          </div>
          <div>
            <div class="muted">–ö–∞–±–∏–Ω–µ—Ç (override)</div>
            <input class="input" data-order="${order}" data-kind="cab" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 24" value="${esc(curCab)}">
          </div>
        </div>

        <div class="muted" style="margin-top:8px">–ï—Å–ª–∏ override –ø—É—Å—Ç–æ–π ‚Äî –≤–æ–∑—å–º—ë—Ç—Å—è –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–∞.</div>
      </div>
    `;
  }).join("");

  d.querySelector("#save").onclick=async ()=>{
    const lessons=[];
    for(let order=1; order<=maxRows; order++){
      const subjSel = rowsBox.querySelector(`select[data-order="${order}"][data-kind="subj"]`);
      const sid = subjSel?.value || "";
      if(!sid) continue;
      const teacherName = norm(rowsBox.querySelector(`input[data-order="${order}"][data-kind="teacher"]`)?.value || "");
      const cabinet = norm(rowsBox.querySelector(`input[data-order="${order}"][data-kind="cab"]`)?.value || "");
      const rec = {order, subjectId:sid};
      if(teacherName) rec.teacherName = teacherName;
      if(cabinet) rec.cabinet = cabinet;
      lessons.push(rec);
    }

    const idx = db.schedule_overrides.findIndex(o=>o.teacherId===teacherId && o.date===iso);
    if(idx>=0) db.schedule_overrides[idx] = {...db.schedule_overrides[idx], lessons};
    else db.schedule_overrides.push({id:uid("ov"), teacherId, date:iso, lessons});

    await saveDB();
    d.close();
  };

  d.querySelector("#del").onclick=async ()=>{
    if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ? –í–µ—Ä–Ω—ë—Ç—Å—è –±–∞–∑–æ–≤–æ–µ.")) return;
    db.schedule_overrides = db.schedule_overrides.filter(o=>!(o.teacherId===teacherId && o.date===iso));
    await saveDB();
    d.close();
  };
}

function renderTeacherSubject(){
  const t=meTeacher();
  const subj = subjectById(t.id, selectedSubjectId);
  if(!subj){ view=VIEW.TEACHER; teacherTab="journal"; render(); return; }

  const myStudents = db.students.filter(s=>s.teacherId===t.id).sort((a,b)=>a.fullName.localeCompare(b.fullName,'ru'));
  const iso = todayISO();

  app.innerHTML=`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">üìò ${esc(subj.title)}</div>
          <div class="muted">–ö–ª–∞—Å—Å: <b>${esc(t.className)}</b> ‚Ä¢ –ö–∞–±: <b>${esc(subj.cabinet||t.cabinet)}</b></div>
        </div>
        <div class="row">
          <button class="btn" id="back">‚Üê –ù–∞–∑–∞–¥</button>
          <button class="btn p" id="addHW">+ –î–æ–±–∞–≤–∏—Ç—å –î–ó</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="align-items:flex-end">
        <div style="flex:1">
          <div class="muted">–î–∞—Ç–∞ —É—Ä–æ–∫–∞</div>
          <input class="input" id="date" type="date" value="${esc(iso)}">
        </div>
        <div style="flex:1">
          <div class="muted">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ (–¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ü–µ–Ω–æ–∫ –∑–∞ —É—Ä–æ–∫)</div>
          <input class="input" id="lessonOrder" type="number" min="1" max="10" value="1">
        </div>
      </div>

      <div class="hr"></div>

      <div class="title" style="font-size:16px">–£—á–µ–Ω–∏–∫–∏</div>
      <div class="muted">–ù–∞–∂–∏–º–∞–π ‚Äú+ –û—Ü–µ–Ω–∫–∞‚Äù, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ü–µ–Ω–æ–∫ –∑–∞ –æ–¥–∏–Ω —É—Ä–æ–∫.</div>

      <div class="hr"></div>
      <div class="list" id="studs"></div>
    </div>
  `;

  $("#back").onclick=()=>{ view=VIEW.TEACHER; teacherTab="journal"; selectedSubjectId=null; render(); };
  $("#addHW").onclick=()=>{ const date=$("#date").value || todayISO(); openAddHomework(t.id, subj.id, date); };

  const list=$("#studs");
  list.innerHTML = myStudents.map(s=>`
      <div class="item">
        <div class="h">
          <div class="l">${esc(s.fullName)}</div>
          <div class="r">–ª–æ–≥–∏–Ω: <span class="kbd">${esc(s.login)}</span></div>
        </div>
        <div class="sub row" style="margin-top:10px">
          <button class="btn p" data-add="${esc(s.id)}">+ –û—Ü–µ–Ω–∫–∞</button>
          <button class="btn" data-view="${esc(s.id)}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button>
        </div>
      </div>
  `).join("");

  list.querySelectorAll("button[data-add]").forEach(btn=>{
    btn.onclick=()=>{
      const studentId=btn.getAttribute("data-add");
      const date=$("#date").value || todayISO();
      const lessonOrder = Math.max(1, Math.min(10, Number($("#lessonOrder").value||1)));
      openAddMark(t.id, subj.id, studentId, date, lessonOrder);
    };
  });
  list.querySelectorAll("button[data-view]").forEach(btn=>{
    btn.onclick=()=>openStudentMarks(t.id, subj.id, btn.getAttribute("data-view"));
  });
}

function openAddHomework(teacherId, subjectId, date){
  const subj=subjectById(teacherId, subjectId);
  const d=modal(`
    <div class="row" style="justify-content:space-between">
      <div><div class="title">–î–æ–±–∞–≤–∏—Ç—å –î–ó</div><div class="muted">${esc(subj?.title||"")} ‚Ä¢ ${esc(date)}</div></div>
      <button class="btn" id="x">‚úï</button>
    </div>
    <div class="hr"></div>
    <textarea class="ta" id="text" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ..."></textarea>
    <div class="row" style="margin-top:12px"><button class="btn p" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  `);
  d.querySelector("#x").onclick=()=>d.close();
  d.querySelector("#save").onclick=async ()=>{
    const text=norm(d.querySelector("#text").value);
    if(!text){ alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –î–ó"); return; }
    db.homeworks.push({id:uid("hw"), teacherId, subjectId, date, text, createdAt:new Date().toISOString()});
    await saveDB();
    d.close();
  };
}

function openAddMark(teacherId, subjectId, studentId, date, lessonOrder){
  const s = db.students.find(x=>x.id===studentId);
  const subj = subjectById(teacherId, subjectId);
  const d=modal(`
    <div class="row" style="justify-content:space-between">
      <div><div class="title">–û—Ü–µ–Ω–∫–∞</div><div class="muted">${esc(s?.fullName||"")} ‚Ä¢ ${esc(subj?.title||"")} ‚Ä¢ ${esc(date)} ‚Ä¢ —É—Ä–æ–∫ ${lessonOrder}</div></div>
      <button class="btn" id="x">‚úï</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div>
        <div class="muted">–û—Ü–µ–Ω–∫–∞</div>
        <select class="select" id="mark">
          <option value="5">5</option><option value="4">4</option><option value="3">3</option>
          <option value="2">2</option><option value="1">1</option>
          <option value="N">N (–ø—Ä–æ–ø—É—Å–∫/–±–æ–ª–µ–∑–Ω—å)</option><option value="O">O (–æ—Å–≤–æ–±.)</option>
        </select>
      </div>
      <div>
        <div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
        <input class="input" id="c" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      </div>
    </div>
    <div class="row" style="margin-top:12px"><button class="btn p" id="save">–î–æ–±–∞–≤–∏—Ç—å</button></div>
  `);
  d.querySelector("#x").onclick=()=>d.close();
  d.querySelector("#save").onclick=async ()=>{
    const mark=d.querySelector("#mark").value;
    const comment=norm(d.querySelector("#c").value);
    db.marks.push({id:uid("m"), teacherId, studentId, subjectId, date, lessonOrder, mark, comment, createdAt:new Date().toISOString()});
    await saveDB();
    d.close();
  };
}

function openStudentMarks(teacherId, subjectId, studentId){
  const s = db.students.find(x=>x.id===studentId);
  const subj = subjectById(teacherId, subjectId);

  const marks = db.marks
    .filter(m=>m.teacherId===teacherId && m.studentId===studentId && m.subjectId===subjectId)
    .sort((a,b)=> (b.date+(b.createdAt||"")).localeCompare(a.date+(a.createdAt||"")));

  const d=modal(`
    <div class="row" style="justify-content:space-between">
      <div><div class="title">${esc(s?.fullName||"")}</div><div class="muted">${esc(subj?.title||"")}</div></div>
      <button class="btn" id="x">‚úï</button>
    </div>
    <div class="hr"></div>
    ${marks.length ? `<div class="list" id="ml"></div>` : `<div class="muted">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫.</div>`}
  `);
  d.querySelector("#x").onclick=()=>d.close();

  if(marks.length){
    const ml=d.querySelector("#ml");
    ml.innerHTML = marks.map(m=>`
      <div class="item">
        <div class="h">
          <div class="l">${esc(m.date)} ‚Ä¢ —É—Ä–æ–∫ ${esc(m.lessonOrder||1)}</div>
          <div class="r"><span class="m ${markCss(m.mark)}">${esc(m.mark)}</span></div>
        </div>
        ${m.comment? `<div class="sub">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${esc(m.comment)}</div>` : ``}
        <div class="sub row" style="margin-top:10px"><button class="btn d" data-del="${esc(m.id)}">–£–¥–∞–ª–∏—Ç—å</button></div>
      </div>
    `).join("");

    ml.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.onclick=async ()=>{
        const id=btn.getAttribute("data-del");
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É?")) return;
        db.marks = db.marks.filter(x=>x.id!==id);
        await saveDB();
        d.close();
      };
    });
  }
}

function renderStudentLike(kind){
  const student = (kind==="student") ? meStudent() : (()=>{
    const p=meParent();
    return p ? db.students.find(s=>s.id===p.studentId)||null : null;
  })();
  if(!student){ app.innerHTML=`<div class="card"><div class="title">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞</div></div>`; return; }

  const teacher = teacherOfStudent(student);
  const called = isParentsCalled(student.id);

  const dates = weekDates(weekOffset);
  const mondayISO = dates[0];
  const head = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">${esc(student.fullName)}</div>
          <div class="muted">
            ${kind==="parent" ? "–†–æ–¥–∏—Ç–µ–ª—å" : "–£—á–µ–Ω–∏–∫"} ‚Ä¢
            –ö–ª–∞—Å—Å: <b>${esc(student.className)}</b> ‚Ä¢
            –£—á–∏—Ç–µ–ª—å: <b>${esc(teacher?.fullName||"‚Äî")}</b>
          </div>
        </div>
        <div class="row">
          <div class="pill">${esc(weekLabel(mondayISO))}</div>
          <button class="btn" id="prev">‚Äπ</button>
          <button class="btn" id="next">‚Ä∫</button>
          <button class="btn" id="today">–°–µ–≥–æ–¥–Ω—è</button>
        </div>
      </div>
    </div>
    <div style="height:12px"></div>
  `;
  const banner = (called && studentTab==="skips") ? `<div class="bannerDanger">–í–ê–®–ò–• –†–û–î–ò–¢–ï–õ–ï–ô –í–´–ó–í–ê–õ–ò –í –®–ö–û–õ–£, –•–ê–•–ê–•–ê–•–ê</div>` : ``;

  app.innerHTML = head + banner + `<div id="body"></div>`;
  $("#prev").onclick=()=>{ weekOffset--; render(); };
  $("#next").onclick=()=>{ weekOffset++; render(); };
  $("#today").onclick=()=>{ weekOffset=0; render(); };

  const body=$("#body");
  const tid = student.teacherId;

  if(studentTab==="schedule"){
    body.innerHTML = `
      <div class="card">
        <div class="title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="muted">–ü–æ –¥–∞—Ç–∞–º (–µ—Å–ª–∏ —É—á–∏—Ç–µ–ª—å –º–µ–Ω—è–ª –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å ‚Äî —É–≤–∏–¥–∏—à—å –∑–∞–º–µ–Ω—É + –∫–∞–±–∏–Ω–µ—Ç/—É—á–∏—Ç–µ–ª—è).</div>
        <div class="hr"></div>
        <div class="list">
          ${dates.map(iso=>{
            const lessons = lessonsForDate(tid, iso);
            const show = lessons.length
              ? lessons.map(l=>{
                  const sub = subjectById(tid, l.subjectId);
                  const tName = l.teacherName || sub?.teacherName || teacher?.fullName || "‚Äî";
                  const cab = l.cabinet || sub?.cabinet || teacher?.cabinet || "‚Äî";
                  return `<div class="item" style="margin-top:8px">
                    <div class="h">
                      <div class="l">${esc(l.order)}. ${esc(sub?.title||"‚Äî")}</div>
                      <div class="r">${esc(tName)} ‚Ä¢ –∫–∞–±. ${esc(cab)}</div>
                    </div>
                  </div>`;
                }).join("")
              : `<div class="muted" style="margin-top:8px">–ù–µ—Ç —É—Ä–æ–∫–æ–≤</div>`;
            return `
              <div class="item">
                <div class="h"><div class="l">${esc(iso)} (${esc(dayName(iso))})</div><div class="r"></div></div>
                <div style="margin-top:8px">${show}</div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;
  }

  if(studentTab==="tasks"){
    const hws = hwForTeacherWeek(tid, dates).sort((a,b)=> (b.date+(b.createdAt||"")).localeCompare(a.date+(a.createdAt||"")));
    body.innerHTML = `
      <div class="card">
        <div class="title">–ó–∞–¥–∞–Ω–∏—è (–î–ó)</div>
        <div class="muted">–î–ó –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—á–∏—Ç–µ–ª—å. ${kind==="student" ? "–ú–æ–∂–Ω–æ –æ—Ç–º–µ—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ." : "–†–æ–¥–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä."}</div>
        <div class="hr"></div>
        ${hws.length ? `<div class="list" id="hws"></div>` : `<div class="muted">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π.</div>`}
      </div>
    `;
    if(hws.length){
      const box=$("#hws");
      box.innerHTML = hws.map(h=>{
        const sub = subjectById(tid, h.subjectId);
        const done = getTaskDone(student.id, h.id);
        return `
          <div class="item">
            <div class="h"><div class="l">${esc(h.date)} ‚Ä¢ ${esc(sub?.title||"‚Äî")}</div><div class="r">${done ? "‚úÖ" : ""}</div></div>
            <div class="sub" style="margin-top:8px">${esc(h.text)}</div>
            ${kind==="student" ? `<div class="row" style="margin-top:10px"><button class="btn ${done?"ok":"p"}" data-done="${esc(h.id)}">${done?"–í—ã–ø–æ–ª–Ω–µ–Ω–æ":"–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"}</button></div>` : ``}
          </div>
        `;
      }).join("");

      if(kind==="student"){
        box.querySelectorAll("button[data-done]").forEach(btn=>{
          btn.onclick=async ()=>{
            const id=btn.getAttribute("data-done");
            const now = !getTaskDone(student.id, id);
            await setTaskDone(student.id, id, now);
          };
        });
      }
    }
  }

  if(studentTab==="grades" || studentTab==="skips"){
    const marks = marksForStudentWeek(tid, student.id, dates);
    const byDate = {};
    for(const m of marks){ (byDate[m.date] ||= []).push(m); }

    function renderDay(iso, onlySkips){
      const arr = (byDate[iso]||[]).slice()
        .sort((a,b)=> (a.lessonOrder||1)-(b.lessonOrder||1) || (a.createdAt||"").localeCompare(b.createdAt||""));

      const groups = {};
      for(const m of arr){
        if(onlySkips && !(m.mark==="N" || m.mark==="O")) continue;
        const key = `${m.subjectId}|${m.lessonOrder||1}`;
        (groups[key] ||= []).push(m);
      }
      const keys = Object.keys(groups);
      if(!keys.length){
        return `
          <div class="item">
            <div class="h"><div class="l">${esc(iso)} (${esc(dayName(iso))})</div><div class="r"></div></div>
            <div class="sub" style="margin-top:8px">–ù–µ—Ç ${onlySkips?"–ø—Ä–æ–ø—É—Å–∫–æ–≤":"–æ—Ü–µ–Ω–æ–∫"}.</div>
          </div>
        `;
      }
      keys.sort((a,b)=>Number(a.split("|")[1]||1)-Number(b.split("|")[1]||1));

      const rows = keys.map(k=>{
        const [subjectId, orderStr] = k.split("|");
        const order = Number(orderStr||1);
        const sub = subjectById(tid, subjectId);
        const ms = groups[k];
        return `
          <div class="item" style="margin-top:8px">
            <div class="h">
              <div class="l">${esc(sub?.title||"‚Äî")} ‚Ä¢ —É—Ä–æ–∫ ${order}</div>
              <div class="r">${esc(sub?.teacherName||teacher?.fullName||"‚Äî")}</div>
            </div>
            <div class="marks">
              ${ms.map(x=>`<span class="m ${markCss(x.mark)}" title="${esc(x.comment||"")}">${esc(x.mark)}${x.comment? " ¬∑":""}</span>`).join("")}
            </div>
            ${ms.some(x=>x.comment) ? `<div class="sub" style="margin-top:8px">${ms.filter(x=>x.comment).map(x=>`‚Ä¢ ${esc(x.comment)}`).join("<br>")}</div>` : ``}
          </div>
        `;
      }).join("");

      return `
        <div class="item">
          <div class="h"><div class="l">${esc(iso)} (${esc(dayName(iso))})</div><div class="r"></div></div>
          <div style="margin-top:8px">${rows}</div>
        </div>
      `;
    }

    const onlySkips = (studentTab==="skips");
    body.innerHTML = `
      <div class="card">
        <div class="title">${onlySkips ? "–ü—Ä–æ–ø—É—Å–∫" : "–û—Ü–µ–Ω–∫–∏"}</div>
        <div class="muted">${onlySkips ? "–¢—É—Ç —Ç–æ–ª—å–∫–æ N / O." : "–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ü–µ–Ω–æ–∫ –∑–∞ –æ–¥–∏–Ω —É—Ä–æ–∫."}</div>
        <div class="hr"></div>
        <div class="list">${dates.map(iso=>renderDay(iso, onlySkips)).join("")}</div>
      </div>
    `;
  }
}

(function boot(){
  function updateBottom(){
    const on = (session?.role==="student" || session?.role==="parent");
    showBottomNav(on);
    if(on) setNavActive();
  }
  const _render = render;
  render = function(){ _render(); updateBottom(); };

  startSync();
  render();
})();
</script>
</body>
</html>
